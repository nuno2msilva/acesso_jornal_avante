<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Portal Jornal Avante</title>
    <style>
        html,body {
            height: 100%
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial
        }

        .card {
            max-width: 720px;
            padding: 28px;
            border-radius: 10px;
            text-align: center
        }

        h1 {
            font-size: 1.6rem;
            margin: 0 0 .5rem
        }

        p {
            margin: .4rem 0;
            font-size: 1rem
        }

        #status {
            font-size: 1.05rem;
            margin-top: 10px
        }

        button {
            margin-top: 14px;
            padding: .6rem 1rem;
            border: 0;
            border-radius: 8px;
            background: #0b5fff;
            color: white;
            cursor: pointer
        }

        a.inline {
            color: #0b5fff
        }

        pre {
            background: #f6f8fa;
            padding: 8px;
            border-radius: 6px;
            overflow: auto
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>Portal "Jornal Avante" Online</h1><br><br>
        <img src="https://www.avante.pt/arquivo/imagens/avante.gif"><br><br>
        <p>Bem vindu, camarada(s)!</p>
        <p id="lead">De acordo com os meus c√°lculos, a edi√ß√£o n¬∫ <strong id="edition">...</strong> √© a mais recente...</p>
        <p>Esta edi√ß√£o √© prevista ser do dia <strong id="date">...</strong>...</p><br>

        <div id="status">üîÑ A preparar a verifica√ß√£o... üîÑ</div>

        <div id="actions" style="margin-top:12px">
            <button id="openPdf" style="display:none">Abrir PDF</button>
        </div>

        <div id="manual" style="margin-top:14px;color:#444;font-size:.95rem"></div>

        <div style="margin-top:20px;font-size:.8rem;color:#666">
            <p><strong>Nota:</strong> Existem browsers (como em dispositivos m√≥veis) que n√£o abrem PDFs diretamente.<br>
            Nesse caso, verifica as transfer√™ncias para verificar se descarregou o jornal em formato PDF!</p>
        </div>
    </div>

    <script>
        // Configura√ß√£o: Edi√ß√£o n¬∫ 2534 saiu a 23/06/2022 (quinta-feira)
        // A edi√ß√£o dispon√≠vel online mais antiga √© a 2533 (verificado a 18/11/2024)
        // Mas como a EDI√á√ÉO n¬∫ 2533 saiu QUARTA-FEIRA (15/06/2022), iniciei o contador na 2534
        const NUMERO_EDICAO_INICIAL = 2534;
        const DATA_PUBLICACAO_INICIAL = new Date('2022-06-23T08:00:00'); // Data da edi√ß√£o n¬∫ 2534
        const DIA_SEMANA_PUBLICACAO = 4; // Index come√ßa no 0, logo se √© DOMINGO = 0, ..., QUINTA = 4

        // Calcular a edi√ß√£o atual (considerando QUINTA √†s 08:00 da manh√£)
        const dataAtual = new Date(); 
        dataAtual.setHours(8, 0, 0, 0);
        const diaDaSemanaAtual = dataAtual.getDay();
        const diasAteProximaQuinta = (diaDaSemanaAtual + 7 - DIA_SEMANA_PUBLICACAO) % 7;
        const dataQuintaFeiraMaisRecente = new Date(dataAtual.getTime() - diasAteProximaQuinta * 24 * 60 * 60 * 1000);
        const numeroDeSemanasDesdeInicio = Math.floor((dataQuintaFeiraMaisRecente - DATA_PUBLICACAO_INICIAL) / (7 * 24 * 60 * 60 * 1000));
        const numeroEdicaoAtual = NUMERO_EDICAO_INICIAL + numeroDeSemanasDesdeInicio;

        // Fun√ß√£o auxiliar: calcula a data de uma edi√ß√£o espec√≠fica
        const obterDataDaEdicao = (numeroEdicao) => {
            const semanasDesdeEdicaoInicial = numeroEdicao - NUMERO_EDICAO_INICIAL;
            const milissegundosPorSemana = 7 * 24 * 60 * 60 * 1000;
            return new Date(DATA_PUBLICACAO_INICIAL.getTime() + (semanasDesdeEdicaoInicial * milissegundosPorSemana));
        };

        // Fun√ß√£o auxiliar: formata data em portugu√™s (ex: "16 de Outubro de 2025")
        const formatarDataEmPortugues = (data) => {
            try {
                const dataFormatada = new Intl.DateTimeFormat('pt-PT', { day: 'numeric', month: 'long', year: 'numeric' }).format(data);
                return dataFormatada.replace(/ de ([a-z√ß√£√µ√©√≠√≥√∫]+) de /i, (correspondencia, mes) => ' de ' + mes.charAt(0).toUpperCase() + mes.slice(1) + ' de ');
            } catch (erro) {
                return data.toLocaleDateString();
            }
        };

        // Exibir edi√ß√£o e data correspondente
        const elementoData = document.getElementById('date');
        const dataPublicacaoEdicaoAtual = obterDataDaEdicao(numeroEdicaoAtual);
        if (elementoData) elementoData.textContent = formatarDataEmPortugues(dataPublicacaoEdicaoAtual);

        const urlPdfEdicaoAtual = `https://www.avante.pt/public/pdf/${numeroEdicaoAtual}_avante.pdf`;

        // Elementos da interface
        const elementoNumeroEdicao = document.getElementById('edition');
        const elementoEstado = document.getElementById('status');
        const botaoAbrirPdf = document.getElementById('openPdf');
        const elementoInstrucoesManual = document.getElementById('manual');

        elementoNumeroEdicao.textContent = numeroEdicaoAtual;

        // Fun√ß√£o auxiliar: fetch com timeout
        const buscarComTimeout = (url, opcoes = {}, milissegundosTimeout = 5000) => {
            const controladorAbortagem = new AbortController();
            const idTimeout = setTimeout(() => controladorAbortagem.abort(), milissegundosTimeout);
            return fetch(url, { ...opcoes, signal: controladorAbortagem.signal }).finally(() => clearTimeout(idTimeout));
        };

        // Verifica disponibilidade do PDF atrav√©s de proxy p√∫blico
        const verificarDisponibilidade = async (urlParaVerificar) => {
            try {
                const urlProxyPublico = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(urlParaVerificar);
                const respostaProxy = await buscarComTimeout(urlProxyPublico, {}, 8000);
                return respostaProxy && typeof respostaProxy.status === 'number' ? respostaProxy.status : null;
            } catch (erro) {
                console.debug('Verifica√ß√£o falhou:', erro);
                return null;
            }
        };

        // Fluxo simplificado: 200-> Redirecionar, 404->tentar edi√ß√£o anterior, other-> Mensagem
        (async () => {
            elementoEstado.textContent = 'üîé A verificar disponibilidade...';
            const codigoEstadoHttp = await verificarDisponibilidade(urlPdfEdicaoAtual);
            
            if (codigoEstadoHttp === 200) {
                // Sucesso: redirecionar ap√≥s 2s
                elementoEstado.textContent = '‚úÖ A edi√ß√£o foi encontrada! A abrir o Jornal Avante...';
                botaoAbrirPdf.style.display = 'inline-block';
                setTimeout(() => window.location.href = urlPdfEdicaoAtual, 2000);
                return;
            }
            
            if (codigoEstadoHttp === 404) {
                // Edi√ß√£o n√£o encontrada: tentar edi√ß√£o anterior
                const numeroEdicaoAnterior = numeroEdicaoAtual - 1;
                const dataPublicacaoEdicaoAnterior = obterDataDaEdicao(numeroEdicaoAnterior);
                elementoEstado.textContent = '‚ö†Ô∏è Edi√ß√£o atual ainda n√£o parece estar dispon√≠vel! A tentar edi√ß√£o anterior...';
                const urlPdfEdicaoAnterior = `https://www.avante.pt/public/pdf/${numeroEdicaoAnterior}_avante.pdf`;
                const codigoEstadoEdicaoAnterior = await verificarDisponibilidade(urlPdfEdicaoAnterior);
                
                if (codigoEstadoEdicaoAnterior === 200) {
                    elementoEstado.textContent = `‚úÖ Edi√ß√£o ${numeroEdicaoAnterior} (${formatarDataEmPortugues(dataPublicacaoEdicaoAnterior)}) dispon√≠vel! A abrir...`;
                    botaoAbrirPdf.style.display = 'inline-block';
                    botaoAbrirPdf.textContent = `Abrir Edi√ß√£o ${numeroEdicaoAnterior}`;
                    setTimeout(() => window.location.href = urlPdfEdicaoAnterior, 2000);
                } else {
                    elementoEstado.textContent = '‚ùå Algo correu mal...';
                    elementoInstrucoesManual.innerHTML = '<p>Por favor, tenta novamente mais tarde.</p>';
                    botaoAbrirPdf.style.display = 'inline-block';
                    botaoAbrirPdf.textContent = 'Tentar Novamente';
                    botaoAbrirPdf.onclick = () => location.reload();
                }
                return;
            }
            
            // Outros erros: mensagem amig√°vel
            elementoEstado.textContent = '‚ö†Ô∏è N√£o foi poss√≠vel verificar a disponibilidade.';
            elementoInstrucoesManual.innerHTML = '<p>Por favor, tenta abrir manualmente ou volta mais tarde.</p>';
            botaoAbrirPdf.style.display = 'inline-block';
            botaoAbrirPdf.textContent = 'Tentar Abrir';
            botaoAbrirPdf.onclick = () => window.open(urlPdfEdicaoAtual, '_blank');
        })();
    </script>
</body>

</html>